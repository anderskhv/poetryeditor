<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonnet 18 Rhyme Scheme Diagnosis</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1, h2 { color: #4ec9b0; }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #252526;
      border-left: 3px solid #4ec9b0;
    }
    .pass { color: #4ec9b0; }
    .fail { color: #f48771; }
    .warn { color: #dcdcaa; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #3e3e42;
    }
    th { color: #4ec9b0; }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .phoneme { color: #ce9178; }
    .label { color: #9cdcfe; }
  </style>
</head>
<body>
  <h1>Sonnet 18 Rhyme Scheme Detection Diagnosis</h1>
  <div id="output"></div>

  <script type="module">
    import { assessRhymeQuality, detectRhymeScheme } from './src/utils/rhymeScheme.ts';
    import { detectPoetricForm } from './src/utils/formDetector.ts';
    import { loadCMUDictionary, getPronunciations } from './src/utils/cmuDict.ts';

    const sonnet18 = `Shall I compare thee to a summer's day?
Thou art more lovely and more temperate:
Rough winds do shake the darling buds of May,
And summer's lease hath all too short a date:
Sometime too hot the eye of heaven shines,
And often is his gold complexion dimmed,
And every fair from fair sometime declines,
By chance, or nature's changing course untrimmed:
But thy eternal summer shall not fade,
Nor lose possession of that fair thou ow'st,
Nor shall death brag thou wander'st in his shade,
When in eternal lines to time thou grow'st,
So long as men can breathe, or eyes can see,
So long lives this, and this gives life to thee.`;

    const expectedEndWords = [
      'day', 'temperate', 'may', 'date',
      'shines', 'dimmed', 'declines', 'untrimmed',
      'fade', "ow'st", 'shade', "grow'st",
      'see', 'thee'
    ];

    const expectedPairs = [
      ['day', 'may'],
      ['temperate', 'date'],
      ['shines', 'declines'],
      ['dimmed', 'untrimmed'],
      ['fade', 'shade'],
      ["ow'st", "grow'st"],
      ['see', 'thee']
    ];

    const output = document.getElementById('output');

    function log(html) {
      output.innerHTML += html;
    }

    function getRhymingPart(word) {
      const pronunciations = getPronunciations(word);
      if (pronunciations.length === 0) {
        return { phones: [word.slice(-3)], fromDict: false };
      }

      const phones = pronunciations[0].phones;
      let lastStressedIndex = -1;
      for (let i = phones.length - 1; i >= 0; i--) {
        if (phones[i].match(/[12]$/)) {
          lastStressedIndex = i;
          break;
        }
      }

      if (lastStressedIndex === -1) {
        return { phones, fromDict: true };
      }

      return { phones: phones.slice(lastStressedIndex), fromDict: true };
    }

    async function runDiagnosis() {
      log('<div class="section"><h2>Step 1: Loading CMU Dictionary</h2>');
      try {
        await loadCMUDictionary();
        log('<p class="pass">✓ CMU Dictionary loaded successfully</p>');
      } catch (error) {
        log(`<p class="fail">✗ Failed to load CMU Dictionary: ${error}</p>`);
        log('<p class="warn">Continuing with fallback...</p>');
      }
      log('</div>');

      // Test 1: Word pair analysis
      log('<div class="section"><h2>Step 2: Rhyme Quality Assessment</h2>');
      log('<p>Testing expected rhyme pairs from Sonnet 18:</p>');
      log('<table><tr><th>Word 1</th><th>Word 2</th><th>Quality</th><th>Phonemes</th></tr>');

      for (const [word1, word2] of expectedPairs) {
        const quality = assessRhymeQuality(word1, word2);
        const rhyme1 = getRhymingPart(word1);
        const rhyme2 = getRhymingPart(word2);

        const qualityClass = quality === 'perfect' ? 'pass' : quality === 'slant' ? 'warn' : 'fail';

        log(`<tr>
          <td>${word1}</td>
          <td>${word2}</td>
          <td class="${qualityClass}">${quality}</td>
          <td class="phoneme">
            [${rhyme1.phones.join(' ')}]<br/>
            [${rhyme2.phones.join(' ')}]
          </td>
        </tr>`);
      }
      log('</table></div>');

      // Detailed analysis of temperate vs date
      log('<div class="section"><h2>Step 3: Deep Dive - "temperate" vs "date"</h2>');
      const temp = getPronunciations('temperate')[0];
      const date = getPronunciations('date')[0];

      if (temp && date) {
        log(`<p><strong>temperate</strong>: <span class="phoneme">${temp.phones.join(' ')}</span></p>`);
        log(`<p><strong>date</strong>: <span class="phoneme">${date.phones.join(' ')}</span></p>`);

        const tempRhyme = getRhymingPart('temperate');
        const dateRhyme = getRhymingPart('date');

        log(`<p>Rhyming part of "temperate": <span class="phoneme">${tempRhyme.phones.join(' ')}</span> (${tempRhyme.phones.length} phonemes)</p>`);
        log(`<p>Rhyming part of "date": <span class="phoneme">${dateRhyme.phones.join(' ')}</span> (${dateRhyme.phones.length} phonemes)</p>`);

        log('<p><strong>Why they don\'t rhyme:</strong></p>');
        log('<ul>');
        log(`<li>Length mismatch: ${tempRhyme.phones.length} vs ${dateRhyme.phones.length}</li>`);

        const tempEnd = tempRhyme.phones.slice(-2).map(p => p.replace(/[012]$/, '')).join(' ');
        const dateEnd = dateRhyme.phones.slice(-2).map(p => p.replace(/[012]$/, '')).join(' ');
        log(`<li>Last 2 phonemes: "<span class="phoneme">${tempEnd}</span>" vs "<span class="phoneme">${dateEnd}</span>"</li>`);
        log(`<li>Different vowels in final syllable: AH (uh) vs EY (ay)</li>`);
        log('</ul>');
      }
      log('</div>');

      // Full rhyme scheme detection
      log('<div class="section"><h2>Step 4: Full Rhyme Scheme Detection</h2>');
      const rhymeScheme = detectRhymeScheme(sonnet18);

      log(`<p>Detected pattern: <span class="label">${rhymeScheme.schemePattern.join('')}</span></p>`);
      log(`<p>Expected pattern: <span class="label">ABABCDCDEFEFGG</span></p>`);

      log('<table><tr><th>Line</th><th>End Word</th><th>Detected</th><th>Expected</th><th>Match</th><th>Quality</th></tr>');
      const expectedPattern = 'ABABCDCDEFEFGG';

      for (let i = 0; i < rhymeScheme.schemePattern.length; i++) {
        const detected = rhymeScheme.schemePattern[i];
        const expected = expectedPattern[i];
        const match = detected === expected;
        const matchClass = match ? 'pass' : 'fail';
        const matchSymbol = match ? '✓' : '✗';

        log(`<tr>
          <td>${i + 1}</td>
          <td>${rhymeScheme.lineEndWords[i]}</td>
          <td class="label">${detected}</td>
          <td class="label">${expected}</td>
          <td class="${matchClass}">${matchSymbol}</td>
          <td>${rhymeScheme.rhymeQualities[i]}</td>
        </tr>`);
      }
      log('</table></div>');

      // Structural check
      log('<div class="section"><h2>Step 5: Shakespearean Structure Check</h2>');
      const schemeStr = rhymeScheme.schemePattern.join('');

      log('<p>Testing structural pattern (ignoring exact labels):</p>');
      log('<table><tr><th>Check</th><th>Test</th><th>Result</th></tr>');

      const checks = [
        ['Length = 14', schemeStr.length === 14, schemeStr.length === 14],
        ['ABAB (0==2 && 1==3)', `${schemeStr[0]}==${schemeStr[2]} && ${schemeStr[1]}==${schemeStr[3]}`, schemeStr[0] === schemeStr[2] && schemeStr[1] === schemeStr[3]],
        ['CDCD (4==6 && 5==7)', `${schemeStr[4]}==${schemeStr[6]} && ${schemeStr[5]}==${schemeStr[7]}`, schemeStr[4] === schemeStr[6] && schemeStr[5] === schemeStr[7]],
        ['EFEF (8==10 && 9==11)', `${schemeStr[8]}==${schemeStr[10]} && ${schemeStr[9]}==${schemeStr[11]}`, schemeStr[8] === schemeStr[10] && schemeStr[9] === schemeStr[11]],
        ['GG (12==13)', `${schemeStr[12]}==${schemeStr[13]}`, schemeStr[12] === schemeStr[13]]
      ];

      let allPass = true;
      for (const [check, test, result] of checks) {
        const className = result ? 'pass' : 'fail';
        const symbol = result ? '✓' : '✗';
        log(`<tr><td>${check}</td><td class="phoneme">${test}</td><td class="${className}">${symbol}</td></tr>`);
        if (!result) allPass = false;
      }
      log('</table>');

      log(`<p><strong>Structural match: ${allPass ? '<span class="pass">YES</span>' : '<span class="fail">NO</span>'}</strong></p>`);
      log('</div>');

      // Form detection
      log('<div class="section"><h2>Step 6: Poetic Form Detection</h2>');
      const form = detectPoetricForm(sonnet18);

      log(`<p><strong>Detected form:</strong> ${form.form}</p>`);
      log(`<p><strong>Fit quality:</strong> ${form.fit}</p>`);
      log(`<p><strong>Fit score:</strong> ${form.fitScore || 'N/A'}</p>`);
      log(`<p><strong>Description:</strong> ${form.description}</p>`);

      if (form.issues) {
        log('<p><strong>Issues:</strong></p><ul>');
        for (const issue of form.issues) {
          log(`<li>${issue}</li>`);
        }
        log('</ul>');
      }
      log('</div>');

      // Summary
      log('<div class="section"><h2>Summary</h2>');
      log('<p><strong>ROOT CAUSE:</strong></p>');
      log('<p>The "temperate" and "date" pair does not rhyme according to CMU dictionary phonetics:</p>');
      log('<ul>');
      log('<li>"temperate" ends with unstressed syllable: AH0 T (uh-t sound)</li>');
      log('<li>"date" is a stressed syllable: EY1 T (ay-t sound)</li>');
      log('<li>The vowel sounds are completely different: AH vs EY</li>');
      log('</ul>');
      log('<p>This causes:</p>');
      log('<ul>');
      log('<li>Line 4 to be assigned a new label (C) instead of matching line 2 (B)</li>');
      log('<li>The structural pattern check to fail at position 1==3 (B != C)</li>');
      log('<li>The sonnet to be classified as "Free Verse" instead of "Shakespearean Sonnet"</li>');
      log('</ul>');
      log('<p class="warn"><strong>NOTE:</strong> In Shakespeare\'s time and poetic tradition, "temperate" and "date" were considered acceptable rhymes (slant rhyme or different historical pronunciation).</p>');
      log('</div>');
    }

    runDiagnosis().catch(error => {
      log(`<div class="section"><p class="fail">Error: ${error}</p></div>`);
      console.error(error);
    });
  </script>
</body>
</html>
